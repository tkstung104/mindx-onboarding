<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MindX OpenID Connect Authentication</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 500px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .login-section {
            margin-bottom: 30px;
        }

        .login-button {
            width: 100%;
            padding: 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }

        .login-button:hover {
            background: #45a049;
        }

        .login-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .user-info {
            display: none;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
            margin-top: 20px;
        }

        .user-info.active {
            display: block;
        }

        .logout-button {
            margin-top: 15px;
            padding: 10px 20px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .logout-button:hover {
            background: #d32f2f;
        }

        .user-info h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .user-info p {
            color: #666;
            margin: 5px 0;
        }

        .error {
            display: none;
            padding: 15px;
            background: #fee;
            border: 1px solid #fcc;
            border-radius: 8px;
            color: #c33;
            margin-top: 20px;
        }

        .error.active {
            display: block;
        }

        .loading {
            display: none;
            text-align: center;
            color: #666;
            margin-top: 20px;
        }

        .loading.active {
            display: block;
        }

        .info-box {
            margin-top: 30px;
            padding: 15px;
            background: #e3f2fd;
            border-radius: 8px;
            font-size: 12px;
            color: #1976d2;
        }

        .info-box strong {
            display: block;
            margin-bottom: 5px;
        }

        .token-display {
            margin-top: 15px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 5px;
            font-size: 11px;
            word-break: break-all;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîê MindX OpenID Connect</h1>
        <p class="subtitle">ƒêƒÉng nh·∫≠p v·ªõi MindX Identity Provider</p>

        <div class="login-section" id="loginSection">
            <button class="login-button" id="loginButton" onclick="handleLogin()">
                üîë ƒêƒÉng nh·∫≠p v·ªõi MindX
            </button>
        </div>

        <!-- Loading indicator -->
        <div class="loading" id="loading">
            ‚è≥ ƒêang x·ª≠ l√Ω...
        </div>

        <!-- Error message -->
        <div class="error" id="error"></div>

        <!-- User info (hi·ªÉn th·ªã sau khi ƒëƒÉng nh·∫≠p th√†nh c√¥ng) -->
        <div class="user-info" id="userInfo">
            <h3 id="userName"></h3>
            <p><strong>User ID:</strong> <span id="userId"></span></p>
            <p><strong>Email:</strong> <span id="userEmail"></span></p>
            <p><strong>Username:</strong> <span id="userUsername"></span></p>
            <div class="token-display" id="tokenDisplay" style="display: none;">
                <strong>ID Token:</strong>
                <div id="tokenContent"></div>
            </div>
            <button class="logout-button" onclick="handleLogout()">ƒêƒÉng xu·∫•t</button>
        </div>

        <!-- Info box -->
        <div class="info-box">
            <strong>‚ÑπÔ∏è Th√¥ng tin:</strong>
            <p>Flow: Authorization Code + ID Token</p>
            <ul style="margin-left: 20px; margin-top: 5px;">
                <li>Redirect ƒë·∫øn MindX login page</li>
                <li>Nh·∫≠n authorization code</li>
                <li>Backend ƒë·ªïi code l·∫•y ID Token</li>
                <li>Verify token v·ªõi JWKS</li>
            </ul>
            <p style="margin-top: 10px;">M·ªü Browser Console (F12) ƒë·ªÉ xem log chi ti·∫øt.</p>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================

        // Production: D√πng domain hi·ªán t·∫°i (v√¨ backend ·ªü c√πng domain, ch·ªâ kh√°c path /api)
        const BACKEND_URL = window.location.origin;
        let openIdConfig = null;

        // ============================================
        // INITIALIZATION
        // ============================================

        async function init() {
            console.log('üöÄ Frontend ƒë√£ s·∫µn s√†ng!');
            console.log('üìç Backend URL:', BACKEND_URL);

            try {
                // L·∫•y OpenID configuration t·ª´ backend
                const response = await fetch(`${BACKEND_URL}/api/config`);
                openIdConfig = await response.json();
                console.log('‚úÖ OpenID Config:', openIdConfig);
            } catch (error) {
                console.error('‚ùå Kh√¥ng th·ªÉ l·∫•y config:', error);
                showError('Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. ƒê·∫£m b·∫£o server ƒëang ch·∫°y.');
            }
        }

        // ============================================
        // LOGIN FLOW
        // ============================================

        /**
         * B∆∞·ªõc 1: Redirect user ƒë·∫øn MindX authorization endpoint
         */
        async function handleLogin() {
            if (!openIdConfig) {
                showError('Ch∆∞a load ƒë∆∞·ª£c OpenID configuration');
                return;
            }

            console.log('='.repeat(60));
            console.log('üîê B·∫Øt ƒë·∫ßu login flow...');

            // T·∫°o state v√† code_verifier cho PKCE (n·∫øu c·∫ßn)
            const state = generateRandomString(32);
            const codeVerifier = generateRandomString(128);
            const codeChallenge = await sha256(codeVerifier);
            const codeChallengeBase64 = base64UrlEncode(codeChallenge);

            // L∆∞u v√†o sessionStorage ƒë·ªÉ d√πng sau
            sessionStorage.setItem('oauth_state', state);
            sessionStorage.setItem('oauth_code_verifier', codeVerifier);

            // T·∫°o authorization URL
            const params = new URLSearchParams({
                client_id: openIdConfig.clientId,
                redirect_uri: `${window.location.origin}/callback.html`,
                response_type: 'code',
                scope: 'openid profile email',
                state: state,
                code_challenge: codeChallengeBase64,
                code_challenge_method: 'S256'
            });

            const authUrl = `${openIdConfig.authorizationEndpoint}?${params.toString()}`;
            
            console.log('üì§ Redirect ƒë·∫øn:', authUrl);
            console.log('='.repeat(60));

            // Redirect ƒë·∫øn MindX
            window.location.href = authUrl;
        }

        // ============================================
        // CHECK IF USER ALREADY LOGGED IN
        // ============================================

        /**
         * Ki·ªÉm tra xem user ƒë√£ ƒëƒÉng nh·∫≠p ch∆∞a (t·ª´ sessionStorage)
         */
        function checkLoggedInUser() {
            const userStr = sessionStorage.getItem('user');
            if (userStr) {
                try {
                    const user = JSON.parse(userStr);
                    const idToken = sessionStorage.getItem('idToken');
                    displayUserInfo(user, idToken);
                    console.log('‚úÖ User ƒë√£ ƒëƒÉng nh·∫≠p:', user);
                } catch (error) {
                    console.error('‚ùå L·ªói khi parse user:', error);
                    sessionStorage.removeItem('user');
                    sessionStorage.removeItem('idToken');
                }
            }
        }

        // ============================================
        // UI HELPER FUNCTIONS
        // ============================================

        function showLoading() {
            document.getElementById('loading').classList.add('active');
            document.getElementById('loginButton').disabled = true;
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
            document.getElementById('loginButton').disabled = false;
        }

        function showError(message) {
            const errorEl = document.getElementById('error');
            errorEl.textContent = message;
            errorEl.classList.add('active');
        }

        function hideError() {
            document.getElementById('error').classList.remove('active');
        }

        function displayUserInfo(user, idToken) {
            document.getElementById('userName').textContent = user.name || 'User';
            document.getElementById('userId').textContent = user.id;
            document.getElementById('userEmail').textContent = user.email || 'N/A';
            document.getElementById('userUsername').textContent = user.username || 'N/A';
            
            if (idToken) {
                document.getElementById('tokenContent').textContent = idToken;
                document.getElementById('tokenDisplay').style.display = 'block';
            }
            
            // ·∫®n login button v√† hi·ªÉn th·ªã user info
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('userInfo').classList.add('active');
        }

        function hideUserInfo() {
            document.getElementById('userInfo').classList.remove('active');
        }

        function handleLogout() {
            // X√≥a user info v√† token
            sessionStorage.removeItem('user');
            sessionStorage.removeItem('idToken');
            sessionStorage.removeItem('oauth_state');
            sessionStorage.removeItem('oauth_code_verifier');
            
            // ·∫®n user info v√† hi·ªÉn th·ªã l·∫°i login button
            hideUserInfo();
            hideError();
            document.getElementById('loginSection').style.display = 'block';
            
            console.log('‚úÖ ƒê√£ ƒëƒÉng xu·∫•t');
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        function generateRandomString(length) {
            const array = new Uint8Array(length);
            crypto.getRandomValues(array);
            // Convert Uint8Array to base64url
            const base64 = btoa(String.fromCharCode(...array));
            return base64
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            return new Uint8Array(hashBuffer);
        }

        function base64UrlEncode(bytes) {
            // Convert Uint8Array to base64url
            const base64 = btoa(String.fromCharCode(...bytes));
            return base64
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        // ============================================
        // STARTUP
        // ============================================

        // Kh·ªüi t·∫°o khi page load
        init();

        // Ki·ªÉm tra xem user ƒë√£ ƒëƒÉng nh·∫≠p ch∆∞a
        checkLoggedInUser();
    </script>
</body>
</html>

